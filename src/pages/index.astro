---
import Layout from "../components/Layout.astro";
import { getSiteData } from "../lib/site-data";

const pageTitle = "Sana Holiday na ulit!";
const pageDescription =
  "Philippine holiday countdown and upcoming holidays.";
const canonicalUrl = "https://sanaholidaynaulit.com/";
const socialImage = new URL("/social-card.png", Astro.url).toString();
const socialImageAlt = "Calendar blocks marking the next Philippine holiday";

// Utilities for formatting PHT
const pad2 = (n: number) => String(n).padStart(2, "0");
const toISOManilaMidnight = (dateISO: string) => `${dateISO}T00:00:00+08:00`;
const formatPHT = (iso: string) =>
  new Date(iso).toLocaleString("en-PH", {
    timeZone: "Asia/Manila",
    year: "numeric",
    month: "long",
    day: "numeric",
    weekday: "short",
  });

// Build-time single source of truth
const site = await getSiteData();

const now = Date.now();
const genAt = site.generatedAt ? Date.parse(site.generatedAt) : now;
const isStale = now - genAt > 24 * 60 * 60 * 1000;

const allThree = [site.next, ...site.nextTwo].filter(Boolean);
const target = site.next;
const targetIso = target ? toISOManilaMidnight(target.dateISO) : "";
const eventSchema = allThree.map((holiday: any) => ({
  "@context": "https://schema.org",
  "@type": "Event",
  name: holiday.name,
  startDate: toISOManilaMidnight(holiday.dateISO),
  endDate: toISOManilaMidnight(holiday.dateISO),
  eventAttendanceMode: "https://schema.org/OfflineEventAttendanceMode",
  eventStatus: "https://schema.org/EventScheduled",
  location: {
    "@type": "Place",
    name: "Philippines",
    address: {
      "@type": "PostalAddress",
      addressCountry: "PH",
    },
  },
  description: `${holiday.name} holiday in the Philippines`,
}));
---

<Layout
  title={pageTitle}
  description={pageDescription}
  canonicalUrl={canonicalUrl}
  imageUrl={socialImage}
>
  <Fragment slot="head">
    <meta name="author" content="SanaHolidayNaUlit" />
    <meta name="theme-color" content="#cc7722" />
    <meta property="og:image:alt" content={socialImageAlt} />
    <meta name="twitter:image:alt" content={socialImageAlt} />
    <script type="application/ld+json">
      {JSON.stringify([
        {
          '@context': 'https://schema.org',
          '@type': 'WebSite',
          name: 'SanaHolidayNaUlit',
          url: canonicalUrl,
          description: pageDescription,
          potentialAction: {
            '@type': 'ViewAction',
            target: canonicalUrl,
          },
        },
        ...eventSchema,
      ])}
    </script>
  </Fragment>
  <header class="site-header">
    <div id="header-container" class="container">
      <nav class="toolbar" aria-label="Primary">
        <a
          class="toolbar-link"
          href="/visualizer"
          aria-label="Go to long weekend visualizer"
        >
          long weekend visualizer
          <span class="chev" aria-hidden="true">→</span>
        </a>
      </nav>
    </div>
  </header>

  <main>
    <section class="hero">
      <div id="hero-container" class="container">
        <div id="hero-content" class="hero-box">
          <h1 class="main-title">NEXT HOLIDAY</h1>
          <h2 id="holidayName" class="holiday-name">
            {target?.name ?? "Loading…"}
          </h2>
          <p id="holidayDate" class="muted" aria-live="polite">
            {target ? formatPHT(toISOManilaMidnight(target.dateISO)) : ""}
          </p>
        </div>

        <div
          id="countdown-timer"
          class="timer"
          role="timer"
          aria-live="polite"
          aria-atomic="true"
          aria-label="Countdown to next holiday"
          data-target-iso={targetIso}
          data-holiday-name={target?.name}
        >
          <div class="timer-box">
            <span id="d" class="num" aria-label="Days">00</span>
            <span class="label">DAYS</span>
          </div>
          <div class="timer-box">
            <span id="h" class="num" aria-label="Hours">00</span>
            <span class="label">HOURS</span>
          </div>
          <div class="timer-box">
            <span id="m" class="num" aria-label="Minutes">00</span>
            <span class="label">MINUTES</span>
          </div>
          <div class="timer-box">
            <span id="s" class="num" aria-label="Seconds">00</span>
            <span class="label">SECONDS</span>
          </div>
        </div>

        {
          isStale && (
            <p id="staleNotice" class="note muted">
              Data may be older than 24 hours. Showing cached results.
            </p>
          )
        }

        <p id="todayBanner" class="muted" hidden>
          Today is
          <strong id="todayName"></strong>
        </p>
      </div>
    </section>

    <p class="sentiment-line sentiment-secondary">Matagal pa :(</p>

    <section class="upcoming">
      <div id="upcoming-container" class="container">
        <h2 class="section">Upcoming</h2>
        <ul id="upcomingList" class="plain-list" aria-live="polite">
          {
            allThree.map((it: any) => (
              <li>
                <span class="name">
                  {it.name}
                  {it.longWeekend ? " — long weekend" : ""}
                </span>
                <span class="date">
                  {formatPHT(toISOManilaMidnight(it.dateISO))}
                </span>
              </li>
            ))
          }
        </ul>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div id="footer-container" class="container">
      <div class="footer-meta">
        <small class="muted">
          &copy;
          <span id="year"></span>
          SanaHolidayNaUlit.com
          <br />
          <a class="footer-link" href="mailto:contact@sanaholidaynaulit.com">
            contact@sanaholidaynaulit.com
          </a>
        </small>
        <p class="source">
          Source:
          <a
            href="https://www.officialgazette.gov.ph/nationwide-holidays/"
            target="_blank"
            rel="noopener noreferrer"
          >
            Official Gazette
          </a>
        </p>
      </div>
    </div>
  </footer>

  <script src="/scripts/countdown.js" defer></script>
</Layout>
